<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>K·∫øt qu·∫£ ch·∫•m ƒëi·ªÉm</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .back-btn {
            display: inline-block;
            padding: 12px 30px;
            background: #3498db;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            margin-top: 15px;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: #2980b9;
        }

        .upload-section {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .upload-section h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            display: inline-block;
            padding: 12px 30px;
            background: #27ae60;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .upload-btn:hover {
            background: #229954;
        }

        .file-info {
            margin-top: 10px;
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 15px;
            background: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .tab-btn.active {
            background: #3498db;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .results-table {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }

        th {
            background: #3498db;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: white;
            font-size: 1.5em;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #7f8c8d;
            font-size: 1.2em;
        }

        .score-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
            font-size: 1.1em;
        }

        .rank-1 { background: #f1c40f; }
        .rank-2 { background: #95a5a6; }
        .rank-3 { background: #cd7f32; }
        .rank-other { background: #3498db; }

        .score-high { background: #27ae60; }
        .score-medium { background: #f39c12; }
        .score-low { background: #e74c3c; }

        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #856404;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            table {
                font-size: 0.85em;
            }

            th, td {
                padding: 8px;
            }

            .tabs {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìä K·∫øt qu·∫£ ch·∫•m ƒëi·ªÉm</h1>
            <p style="color: #7f8c8d; margin-top: 10px;">BGK 70% + DX Team 30% = T·ªïng ƒëi·ªÉm √∑ 2</p>
            <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <a href="index.html" class="back-btn">‚Üê Quay l·∫°i trang ch·∫•m ƒëi·ªÉm</a>
                <button id="deleteAllBtn" class="back-btn" style="background: #e74c3c; border: none; cursor: pointer;">
                    üóëÔ∏è X√≥a to√†n b·ªô d·ªØ li·ªáu
                </button>
            </div>
        </div>

        <!-- <div class="upload-section">
            <h3>üìÑ ƒêi·ªÉm b√¨nh ch·ªçn c·ªßa DX Team</h3>
            <p id="audienceStatus" style="color: #7f8c8d;">
                ƒêang t·∫£i file... (a.txt)
            </p>
        </div> -->

        <div id="loading" class="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>

        <div id="mainContent" style="display: none;">
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('final')">üèÜ K·∫øt qu·∫£ cu·ªëi c√πng</button>
                <button class="tab-btn" onclick="switchTab('raw')">üìã D·ªØ li·ªáu th√¥</button>
            </div>

            <!-- Tab 1: ÏµúÏ¢Ö Í≤∞Í≥º -->
            <div id="finalTab" class="tab-content active">
                <div class="results-table">
                    <h2 style="margin-bottom: 20px; color: #333;">X·∫øp h·∫°ng cu·ªëi c√πng</h2>
                    
                    <!-- ÎåÄÍ≤∞ 1: Í≤ÄÏÇ¨/ÌíàÏßà -->
                    <h3 style="color: #3498db; margin: 20px 0 10px 0;">üèÜ Í≤ÄÏÇ¨/ÌíàÏßà</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>H·∫°ng</th>
                                <th>Th√≠ sinh</th>
                                <th>TB BGK<br>(70%)</th>
                                <th>DX Team<br>(30%)</th>
                                <th>T·ªïng</th>
                                <th>ƒêi·ªÉm cu·ªëi<br>(√∑2)</th>
                                <th>S·ªë BGK ƒë√£ ch·∫•m</th>
                            </tr>
                        </thead>
                        <tbody id="group1Body">
                        </tbody>
                    </table>

                    <!-- ÎåÄÍ≤∞ 2: Ïö¥ÏòÅ/ÏÉùÏÇ∞ -->
                    <h3 style="color: #3498db; margin: 30px 0 10px 0;">üèÜ Ïö¥ÏòÅ/ÏÉùÏÇ∞</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>H·∫°ng</th>
                                <th>Th√≠ sinh</th>
                                <th>TB BGK<br>(70%)</th>
                                <th>DX Team<br>(30%)</th>
                                <th>T·ªïng</th>
                                <th>ƒêi·ªÉm cu·ªëi<br>(√∑2)</th>
                                <th>S·ªë BGK ƒë√£ ch·∫•m</th>
                            </tr>
                        </thead>
                        <tbody id="group2Body">
                        </tbody>
                    </table>

                    <!-- ÎåÄÍ≤∞ 3: Í≥µÏ†ï/ÏÑ§ÎπÑ -->
                    <h3 style="color: #3498db; margin: 30px 0 10px 0;">üèÜ Í≥µÏ†ï/ÏÑ§ÎπÑ</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>H·∫°ng</th>
                                <th>Th√≠ sinh</th>
                                <th>TB BGK<br>(70%)</th>
                                <th>DX Team<br>(30%)</th>
                                <th>T·ªïng</th>
                                <th>ƒêi·ªÉm cu·ªëi<br>(√∑2)</th>
                                <th>S·ªë BGK ƒë√£ ch·∫•m</th>
                            </tr>
                        </thead>
                        <tbody id="group3Body">
                        </tbody>
                    </table>

                    <!-- ÎåÄÍ≤∞ 4: ÏÑ§Í≥Ñ/Í∞úÎ∞ú -->
                    <h3 style="color: #3498db; margin: 30px 0 10px 0;">üèÜ ÏÑ§Í≥Ñ/Í∞úÎ∞ú</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>H·∫°ng</th>
                                <th>Th√≠ sinh</th>
                                <th>TB BGK<br>(70%)</th>
                                <th>DX Team<br>(30%)</th>
                                <th>T·ªïng</th>
                                <th>ƒêi·ªÉm cu·ªëi<br>(√∑2)</th>
                                <th>S·ªë BGK ƒë√£ ch·∫•m</th>
                            </tr>
                        </thead>
                        <tbody id="group4Body">
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tab 2: Raw Data -->
            <div id="rawTab" class="tab-content">
                <div class="results-table">
                    <h2 style="margin-bottom: 20px; color: #333;">To√†n b·ªô l·ªãch s·ª≠ ch·∫•m ƒëi·ªÉm (M·ªõi nh·∫•t tr∆∞·ªõc)</h2>
                    <table>
                        <thead>
                            <tr>
                                <th>Th·ªùi gian</th>
                                <th>Ban gi√°m kh·∫£o</th>
                                <th>Th√≠ sinh</th>
                                <th>√ù t∆∞·ªüng</th>
                                <th>Hi·ªáu qu·∫£</th>
                                <th>·∫¢nh h∆∞·ªüng</th>
                                <th>T·ªïng ƒëi·ªÉm</th>
                            </tr>
                        </thead>
                        <tbody id="rawDataBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, getDocs, query, orderBy, deleteDoc, doc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // ========================================
        // THAY CONFIG GI·ªêNG FILE INDEX.HTML
        // ========================================
        const firebaseConfig = {
            apiKey: "AIzaSyD4kO0rxRLfnLnPIwr6mtgLs0utzVS_qMk",
            authDomain: "scoring-system-4993c.firebaseapp.com",
            projectId: "scoring-system-4993c",
            storageBucket: "scoring-system-4993c.firebasestorage.app",
            messagingSenderId: "9687384907",
            appId: "1:9687384907:web:50e9969d943076c924dece"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Chia th√†nh 4 nh√≥m ƒë·∫•u
        const groups = [
            { name: "Ki·ªÉm tra/Ch·∫•t l∆∞·ª£ng", contestants: ["Í≤ÄÏÇ¨/ÌíàÏßà 1", "Í≤ÄÏÇ¨/ÌíàÏßà 2"], bodyId: "group1Body" },
            { name: "V·∫≠n h√†nh/S·∫£n xu·∫•t", contestants: ["Ïö¥ÏòÅ/ÏÉùÏÇ∞ 1", "Ïö¥ÏòÅ/ÏÉùÏÇ∞ 2"], bodyId: "group2Body" },
            { name: "C√¥ng ngh·ªá/Thi·∫øt b·ªã", contestants: ["Í≥µÏ†ï/ÏÑ§ÎπÑ 1", "Í≥µÏ†ï/ÏÑ§ÎπÑ 2"], bodyId: "group3Body" },
            { name: "Thi·∫øt k·∫ø/Ph√°t tri·ªÉn", contestants: ["ÏÑ§Í≥Ñ/Í∞úÎ∞ú 1", "ÏÑ§Í≥Ñ/Í∞úÎ∞ú 2"], bodyId: "group4Body" }
        ];

        let audienceScores = {};
        let allScores = [];

        // Auto load audience scores from a.txt
        async function loadAudienceScores() {
            try {
                const response = await fetch('a.txt');
                if (!response.ok) {
                    throw new Error('Kh√¥ng t√¨m th·∫•y file');
                }
                const text = await response.text();
                audienceScores = parseAudienceScores(text);
                
                const statusEl = document.getElementById('audienceStatus');
                if (statusEl) {
                    statusEl.style.color = '#27ae60';
                    statusEl.innerHTML = `‚úÖ ƒê√£ t·∫£i ƒëi·ªÉm DX Team: ${Object.keys(audienceScores).length} ng∆∞·ªùi<br><small>File: a.txt</small>`;
                }
                
                if (allScores.length > 0) {
                    calculateFinalResults();
                }
            } catch (error) {
                console.error('L·ªói t·∫£i file:', error);
                const statusEl = document.getElementById('audienceStatus');
                if (statusEl) {
                    statusEl.style.color = '#e74c3c';
                    statusEl.innerHTML = `‚ùå Kh√¥ng t√¨m th·∫•y file a.txt<br><small>H√£y t·∫°o file a.txt trong c√πng th∆∞ m·ª•c</small>`;
                }
            }
        }

        // Switch tabs
        window.switchTab = function(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tab === 'final') {
                document.querySelectorAll('.tab-btn')[0].classList.add('active');
                document.getElementById('finalTab').classList.add('active');
            } else {
                document.querySelectorAll('.tab-btn')[1].classList.add('active');
                document.getElementById('rawTab').classList.add('active');
            }
        };

        function parseAudienceScores(text) {
            const scores = {};
            const lines = text.split('\n');
            
            lines.forEach(line => {
                line = line.trim();
                if (!line) return;
                
                const match = line.match(/^(.+?):\s*(\d+(?:\.\d+)?)$/);
                if (match) {
                    const name = match[1].trim();
                    const score = parseFloat(match[2]);
                    scores[name] = score;
                }
            });
            
            return scores;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = timestamp.toDate();
            return date.toLocaleString('ko-KR', {
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        function getScoreBadgeClass(score) {
            if (score >= 80) return 'score-high';
            if (score >= 50) return 'score-medium';
            return 'score-low';
        }

        function getRankClass(rank) {
            if (rank === 1) return 'rank-1';
            if (rank === 2) return 'rank-2';
            if (rank === 3) return 'rank-3';
            return 'rank-other';
        }

        async function loadResults() {
            try {
                console.log('üîç B·∫Øt ƒë·∫ßu t·∫£i d·ªØ li·ªáu t·ª´ Firebase...');
                const q = query(collection(db, "scores"), orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);

                console.log('üìä S·ªë l∆∞·ª£ng b·∫£n ghi:', querySnapshot.size);

                if (querySnapshot.empty) {
                    console.log('‚ö†Ô∏è Database tr·ªëng!');
                    document.getElementById('loading').innerHTML = 
                        '<div class="no-data">Ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m ƒëi·ªÉm.<br>Vui l√≤ng ch·∫•m ƒëi·ªÉm t·∫°i trang index.html tr∆∞·ªõc.</div>';
                    return;
                }

                allScores = [];
                querySnapshot.forEach((doc) => {
                    console.log('‚úÖ Document:', doc.data());
                    allScores.push(doc.data());
                });

                displayRawData();
                calculateFinalResults();

                document.getElementById('loading').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';

            } catch (error) {
                console.error('‚ùå L·ªói Firebase:', error);
                console.error('‚ùå M√£ l·ªói:', error.code);
                console.error('‚ùå Th√¥ng b√°o:', error.message);
                document.getElementById('loading').innerHTML = 
                    `<div class="no-data">
                        ‚ùå L·ªói: ${error.message}<br>
                        <small>M√£: ${error.code}</small><br>
                        <small style="color: #e74c3c;">M·ªü F12 Console ƒë·ªÉ xem chi ti·∫øt</small>
                    </div>`;
            }
        }

        function displayRawData() {
            const tbody = document.getElementById('rawDataBody');
            tbody.innerHTML = '';

            allScores.forEach(data => {
                const row = `
                    <tr>
                        <td>${formatDate(data.timestamp)}</td>
                        <td><strong>${data.judgeName}</strong></td>
                        <td>${data.contestantName}</td>
                        <td>${data.innovationScore}</td>
                        <td>${data.presentationScore}</td>
                        <td>${data.technicalScore}</td>
                        <td>
                            <span class="score-badge ${getScoreBadgeClass(data.totalScore)}">
                                ${data.totalScore.toFixed(1)}
                            </span>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        function calculateFinalResults() {
            groups.forEach(group => {
                const results = [];

                group.contestants.forEach(contestant => {
                    // L·∫•y ƒëi·ªÉm cu·ªëi c√πng c·ªßa m·ªói BGK cho th√≠ sinh n√†y
                    const judgeLatestScores = {};
                    
                    allScores.forEach(score => {
                        if (score.contestantName === contestant) {
                            if (!judgeLatestScores[score.judgeName]) {
                                judgeLatestScores[score.judgeName] = score.totalScore;
                            }
                        }
                    });

                    const judgeScoresArray = Object.values(judgeLatestScores);
                    const judgeCount = judgeScoresArray.length;

                    if (judgeCount === 0) return;

                    // T√≠nh trung b√¨nh BGK
                    const bgkAvg = judgeScoresArray.reduce((a, b) => a + b, 0) / judgeCount;

                    // ƒêi·ªÉm DX Team
                    const audienceScore = audienceScores[contestant] || 0;

                    // T√≠nh ƒëi·ªÉm cu·ªëi
                    const bgkWeighted = bgkAvg * 0.7;
                    const audienceWeighted = audienceScore * 0.3;
                    const total = bgkWeighted + audienceWeighted;
                    const finalScore = total / 2;

                    results.push({
                        contestant,
                        bgkAvg: bgkAvg.toFixed(2),
                        bgkWeighted: bgkWeighted.toFixed(2),
                        audienceScore: audienceScore.toFixed(2),
                        audienceWeighted: audienceWeighted.toFixed(2),
                        total: total.toFixed(2),
                        finalScore: finalScore.toFixed(2),
                        judgeCount
                    });
                });

                // S·∫Øp x·∫øp theo ƒëi·ªÉm cu·ªëi gi·∫£m d·∫ßn trong nh√≥m
                results.sort((a, b) => parseFloat(b.finalScore) - parseFloat(a.finalScore));

                displayGroupResults(results, group.bodyId);
            });
        }

        function displayGroupResults(results, bodyId) {
            const tbody = document.getElementById(bodyId);
            tbody.innerHTML = '';

            if (results.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">Ch∆∞a c√≥ d·ªØ li·ªáu ch·∫•m ƒëi·ªÉm</td></tr>';
                return;
            }

            results.forEach((result, index) => {
                const rank = index + 1; // 1 ho·∫∑c 2
                const rankText = rank === 1 ? "H·∫°ng 1" : "H·∫°ng 2";
                const row = `
                    <tr>
                        <td>
                            <span class="score-badge ${getRankClass(rank)}">
                                ${rankText}
                            </span>
                        </td>
                        <td><strong>${result.contestant}</strong></td>
                        <td>${result.bgkAvg}<br><small>(${result.bgkWeighted})</small></td>
                        <td>${result.audienceScore}<br><small>(${result.audienceWeighted})</small></td>
                        <td><strong>${result.total}</strong></td>
                        <td>
                            <span class="score-badge ${getScoreBadgeClass(parseFloat(result.finalScore) * 2)}">
                                ${result.finalScore}
                            </span>
                        </td>
                        <td>${result.judgeCount} / 7</td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });
        }

        // Load data
        loadAudienceScores();
        loadResults();

        // Auto refresh every 30 seconds
        setInterval(loadResults, 30000);

        // Delete all data
        document.getElementById('deleteAllBtn').addEventListener('click', async function() {
            const confirmed = confirm('‚ö†Ô∏è C·∫£nh b√°o: T·∫•t c·∫£ d·ªØ li·ªáu ch·∫•m ƒëi·ªÉm s·∫Ω b·ªã x√≥a vƒ©nh vi·ªÖn!\n\nB·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a?');
            if (!confirmed) return;

            const doubleConfirm = confirm('üö® X√°c nh·∫≠n l·∫ßn cu·ªëi: D·ªØ li·ªáu ƒë√£ x√≥a kh√¥ng th·ªÉ kh√¥i ph·ª•c!\n\nTi·∫øp t·ª•c?');
            if (!doubleConfirm) return;

            try {
                this.disabled = true;
                this.textContent = 'ƒêang x√≥a...';

                const q = query(collection(db, "scores"));
                const querySnapshot = await getDocs(q);

                let deleteCount = 0;
                const deletePromises = [];

                querySnapshot.forEach((document) => {
                    deletePromises.push(deleteDoc(doc(db, "scores", document.id)));
                    deleteCount++;
                });

                await Promise.all(deletePromises);

                alert(`‚úÖ Th√†nh c√¥ng: ƒê√£ x√≥a ${deleteCount} b·∫£n ghi!`);
                
                // Reload page
                location.reload();

            } catch (error) {
                console.error('‚ùå L·ªói x√≥a:', error);
                alert('X√≥a th·∫•t b·∫°i: ' + error.message);
                this.disabled = false;
                this.textContent = 'üóëÔ∏è X√≥a to√†n b·ªô d·ªØ li·ªáu';
            }
        });
    </script>
</body>

</html>
